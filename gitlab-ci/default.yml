image: mvalois/aura-builder

stages:
  - build
  - validate
  - deploy

before_script:
  - export PROJECT=$(pwd)
  - export NODE_PATH=$NODE_PATH:/opt/node_modules
  - cp package.json /opt
  - cd /opt
  - npm install --no-optional --no-audit
  - ln -s /opt/node_modules $PROJECT/node_modules

after_script:
  - cd $PROJECT

check:deps:
  stage: build
  allow_failure: true
  before_script:
    - cp package.json /opt
    - cd /opt
  script:
    - npm ls

build-dev:
  stage: build
  script:
    - SKLT_PROJECT_DIR="$PROJECT/" npm run SKLT_build-dev @all/@all
  artifacts:
    paths:
      - dist/dev
  dependencies: []

build-prod:
  stage: build
  script:
    - SKLT_PROJECT_DIR="$PROJECT/" npm run SKLT_build-dev @all/@all
  artifacts:
    paths:
      - dist/prod
  dependencies: []

validate-html:
  stage: validate
  script:
    - npm run validate-html $PROJECT/dist
  needs: ["build-dev", "build-prod"]

pages:
  stage: deploy
  script:
    - cd $PROJECT
    - mkdir public/dev
    - mkdir public/prod
    - mv dist/* public/
  needs: ["build-dev", "build-prod"]
  artifacts:
    paths:
      - public
  only:
    - master

trigger_build:
  stage: deploy
  before_script:
    - apk add curl
  script:
    - "curl -X POST -F token=${IMAGE_TOKEN} -F ref=master https://git.unicaen.fr/api/v4/projects/524/trigger/pipeline"
  only:
    changes:
      - package.json
    refs:
      - master
  dependencies: []